---
phase: 06-security-dashboard
plan: 02
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified: []
autonomous: false
requirements:
  - DASH-01
  - DASH-02
  - DASH-03

must_haves:
  truths:
    - "Authenticated user navigating to /dashboard sees a table of active sessions with visitorId, IP, user-agent, and status badge columns"
    - "Unauthenticated request to /dashboard redirects to /login"
    - "A session whose DetectionEvent.status is FLAGGED displays a red FLAGGED badge and is clickable to reveal Claude's reasoning and confidence score"
    - "The dashboard data updates without a full page reload within 10 seconds of a new detection event being written"
  artifacts: []
  key_links: []
---

<objective>
Verify the Security Dashboard end-to-end through a structured human walkthrough — confirming auth protection, table rendering, badge display, expandable reasoning panel, and polling behavior.

Purpose: Phase 6 is a UI phase. Automated TypeScript compilation and build checks (from Plan 06-01) prove the code is structurally correct, but only a human can verify that the visual output matches the success criteria. This plan provides the exact steps for that verification.
Output: Confirmed working dashboard satisfying DASH-01, DASH-02, and DASH-03.
</objective>

<execution_context>
@/Users/davidkwartler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidkwartler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-dashboard/06-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    The complete Security Dashboard (Plan 06-01):
    - src/app/(shop)/dashboard/page.tsx — async Server Component with auth check and Prisma query
    - src/app/(shop)/dashboard/PollingRefresher.tsx — client component calling router.refresh() every 8 seconds
    - src/components/SessionTable.tsx — client component with status badges and expandable FLAGGED rows
    - src/app/(shop)/layout.tsx — updated nav with Dashboard link

    The dashboard queries all non-expired sessions, shows original fingerprint data (visitorId, IP, user-agent), derives status from the most recent DetectionEvent, and auto-refreshes every 8 seconds.
  </what-built>
  <how-to-verify>
    **Prerequisites:** Dev server running. If not already running, start it:
    ```bash
    cd /Users/davidkwartler/sentinel && npm run dev
    ```

    ---

    **Check 1 — Auth protection (DASH-01 gate):**
    - Open a new private/incognito browser window (no cookies)
    - Navigate to http://localhost:3000/dashboard
    - Expected: Redirect to http://localhost:3000/login — you do NOT see the dashboard
    - If the dashboard renders without authentication, auth protection is broken — stop and diagnose

    ---

    **Check 2 — Dashboard table renders (DASH-01):**
    - Sign in with Google in your normal browser if not already signed in
    - Navigate to http://localhost:3000/dashboard via the Dashboard link in the nav bar
    - Expected: A table appears with at least one row (your current session)
    - Each row should show:
      - Visitor ID: a 12-character truncated string followed by "…" (or "—" if FingerprintJS Pro is inactive)
      - IP Address: your current IP or "—"
      - User Agent: your browser's user-agent string (truncated) or "—"
      - Status badge: one of ACTIVE (gray), PENDING (yellow), FLAGGED (red), CLEAR (green)
    - If the table is empty, check: is your session non-expired? Open Prisma Studio and verify a Session row exists with `expires` in the future

    ---

    **Check 3 — FLAGGED session badge and expandable panel (DASH-02, DASH-03):**

    If you have an existing FLAGGED session from Phase 5 testing, skip to Check 3b.

    **Check 3a — Simulate a hijack to create a FLAGGED session (if needed):**
    - In Browser A (your normal browser): navigate to /products. Open DevTools → Application → Cookies → find `auth_session` → copy its full value.
    - Open Browser B (a different browser or a fresh Chrome profile — must generate a different FingerprintJS visitorId)
    - In Browser B: Open DevTools → Application → Cookies → manually set cookie: Name=`auth_session`, Value=<pasted value>, Domain=`localhost`, Path=`/`
    - Navigate to http://localhost:3000/products in Browser B
    - Wait 10–15 seconds for Claude to complete the async analysis
    - Return to the dashboard in Browser A

    **Check 3b — Verify FLAGGED display:**
    - The session row for the hijacked session should display a red **FLAGGED** badge (DASH-02 satisfied)
    - Click on the FLAGGED row
    - Expected: An expanded detail panel appears below the row showing:
      - "Confidence Score: XX / 100" (a numeric value between 0 and 100)
      - Claude's full reasoning text paragraph (DASH-03 satisfied)
    - Click the row again — the panel collapses

    ---

    **Check 4 — Polling updates without page reload (DASH-01 success criterion 5):**
    - Keep the dashboard open in Browser A
    - In Browser B, navigate to another shop page (or trigger another fingerprint recording)
    - Watch the dashboard for up to 10 seconds — it should update to reflect any new session state without a manual refresh
    - You can confirm polling is active: open Browser A DevTools → Network tab → filter by "dashboard" or look for periodic server requests — OR simply observe that the dashboard data changes within 10 seconds of a DB update

    ---

    **Expected outcomes for approval:**
    - Unauthenticated access → redirect to /login ✓
    - Authenticated access → table visible with session rows and status badges ✓
    - FLAGGED session → red badge, clickable row, reasoning panel with score and text ✓
    - Dashboard updates within 10 seconds without manual refresh ✓

    **Note on FingerprintJS Pro inactive account (known blocker from Phase 3):**
    If FingerprintJS Pro is inactive, visitorId will be "—" and no detection events will fire. In this case, Check 2 can be approved with "—" values, and Check 3 can be skipped or manually simulated by directly inserting a DetectionEvent row via Prisma Studio with status="FLAGGED", confidenceScore=85, and reasoning="Test reasoning". The dashboard UI must still render correctly regardless of FingerprintJS status.
  </how-to-verify>
  <resume-signal>
    Type "approved" if all four checks pass, or describe what failed (e.g., "auth redirect missing", "table empty", "FLAGGED row not expandable", "polling not working").
  </resume-signal>
</task>

</tasks>

<verification>
All verification is human-driven in this plan (UI/visual behavior cannot be automated). The automated checks were completed in Plan 06-01 (tsc --noEmit, npm run build).

For reference — automated checks that must already be green before this checkpoint:
```bash
# These should have passed in Plan 06-01
cd /Users/davidkwartler/sentinel && npx tsc --noEmit 2>&1 | grep -c "error TS" || echo "0 TS errors"
cd /Users/davidkwartler/sentinel && npm run build 2>&1 | tail -5
```
</verification>

<success_criteria>
1. Navigating to /dashboard while unauthenticated redirects to /login — the dashboard is not visible without a valid session (DASH-01)
2. Authenticated user sees a table of active sessions with four columns: Visitor ID, IP Address, User Agent, Status badge (DASH-01)
3. A session with DetectionEvent.status = "FLAGGED" displays a red FLAGGED badge visually distinguishable from ACTIVE/PENDING/CLEAR rows (DASH-02)
4. Clicking a FLAGGED row expands a panel showing Claude's reasoning text and the numeric confidence score (0–100) (DASH-03)
5. The dashboard refreshes its data within 10 seconds of a new detection event without a manual page reload (DASH-01 success criterion 5)
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-dashboard/06-02-SUMMARY.md` documenting:
- Which checks passed and which (if any) had issues
- Whether FingerprintJS Pro was active during testing (affects Check 3)
- The confidence score and a snippet of Claude's reasoning observed (if a FLAGGED session existed)
- Any bugs found and fixed during verification
- Confirmation that all three dashboard requirements (DASH-01, DASH-02, DASH-03) are satisfied
</output>
