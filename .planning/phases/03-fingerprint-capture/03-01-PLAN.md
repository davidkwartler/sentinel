---
wave: 1
depends_on: []
files_modified:
  - src/components/FingerprintReporter.tsx
autonomous: true
requirements:
  - FP-01
  - FP-02
  - FP-03
  - FP-04
  - FP-05
must_haves:
  truths:
    - "FP-01: FingerprintJSPro.load() is called on every authenticated page load via FingerprintReporter in (shop)/layout.tsx"
    - "FP-02: sessionStorage cache stores a numeric timestamp; cache hit is determined by Date.now() - timestamp < NEXT_PUBLIC_FINGERPRINT_TTL_MS (default 1800000ms)"
    - "FP-03: POST to /api/session/record fires only on cache miss — the early-return before the fetch call skips the POST on cache hit"
    - "FP-04: Fingerprint row contains sessionId, visitorId, os, browser, screenRes, timezone, ip, userAgent"
    - "FP-05: Duplicate requestId returns {status: 'duplicate'} with no new DB row created"
  artifacts:
    - "src/components/FingerprintReporter.tsx — TTL-based cache logic"
    - "src/app/api/session/record/route.ts — ingest endpoint"
    - "prisma/schema.prisma — Fingerprint model"
  key_links:
    - "FingerprintReporter → /api/session/record (fetch POST)"
    - "(shop)/layout.tsx → FingerprintReporter (renders on every auth page)"
    - "route.ts → prisma.fingerprint.create (DB write)"
---

# Plan 03-01: Fix FP-02 TTL Cache + Verify Phase 3

## Goal

Fix the one gap between what was built and the full Phase 3 requirements: FP-02 requires a configurable TTL for the sessionStorage cache. Current implementation uses a lifetime boolean flag. Add timestamp-based TTL driven by `NEXT_PUBLIC_FINGERPRINT_TTL_MS`.

## Tasks

<task id="1" type="auto">
  <files>src/components/FingerprintReporter.tsx</files>
  <action>
Replace the simple boolean sessionStorage flag with a TTL-based timestamp check:

1. On cache read (line ~13): replace `if (sessionStorage.getItem(CACHE_KEY)) return` with:
   ```ts
   const cached = sessionStorage.getItem(CACHE_KEY)
   const ttl = Number(process.env.NEXT_PUBLIC_FINGERPRINT_TTL_MS ?? 1_800_000)
   if (cached && Date.now() - Number(cached) < ttl) return
   ```

2. On cache write (after successful POST): replace `sessionStorage.setItem(CACHE_KEY, "1")` with:
   ```ts
   sessionStorage.setItem(CACHE_KEY, String(Date.now()))
   ```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Cache key stores a numeric timestamp string (not "1"); cache check compares elapsed time against TTL env var</done>
</task>

<task id="2" type="checkpoint:verify">
  <files>
    src/components/FingerprintReporter.tsx
    src/app/api/session/record/route.ts
    prisma/schema.prisma
    src/app/(shop)/layout.tsx
  </files>
  <action>
Verify all Phase 3 success criteria via code inspection and tooling:

```bash
npx tsc --noEmit
npx prisma validate
```

Checklist:
- [ ] FP-01: `FingerprintReporter` imported and rendered in `(shop)/layout.tsx`
- [ ] FP-02: Cache read checks `Date.now() - Number(cached) < ttl`; cache write stores `String(Date.now())`
- [ ] FP-03: The early-return before the `fetch()` call skips POST on cache hit (FP-02 logic gates the entire capture fn)
- [ ] FP-04: `route.ts` writes all fields: sessionId, visitorId, requestId, ip, userAgent, os, browser, screenRes, timezone
- [ ] FP-05: `findUnique({ where: { requestId } })` early-return present; returns `{status: "duplicate"}` without creating a row
  </action>
  <verify>All 5 checklist items confirmed; tsc and prisma validate both pass</verify>
  <done>All Phase 3 success criteria verified by inspection and tooling</done>
</task>
