---
phase: 07-deploy-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(shop)/dashboard/page.tsx
autonomous: false
requirements:
  - DEPLOY-VALIDATION
# Note: Phase 7 introduces no new v1 requirement IDs. All 20 v1 requirements
# were satisfied in Phases 1-6. This plan validates the full system in the
# production environment and satisfies Phase 7 Success Criteria SC-1, SC-2, SC-4.

must_haves:
  truths:
    - "The app is live at a public Vercel URL and the products page loads after Google OAuth sign-in"
    - "All required env vars are confirmed set in Vercel (AUTH_SECRET, AUTH_GOOGLE_ID, AUTH_GOOGLE_SECRET, DATABASE_URL, NEXT_PUBLIC_FINGERPRINT_API_KEY, ANTHROPIC_API_KEY)"
    - "The /dashboard Prisma query uses a select clause that explicitly excludes sessionToken from the returned object"
    - "Google OAuth callback URI for the production Vercel URL is added to Google Cloud Console"
    - "No raw auth_session cookie value is returned by any API endpoint"
  artifacts:
    - path: "src/app/(shop)/dashboard/page.tsx"
      provides: "Dashboard page with secure Prisma query excluding sessionToken"
      contains: "select:"
  key_links:
    - from: "src/app/(shop)/dashboard/page.tsx"
      to: "prisma.session.findMany"
      via: "select clause"
      pattern: "select:.*\\{[^}]*fingerprints|detectionEvents"
---

<objective>
Deploy Sentinel to Vercel production, confirm all environment variables are correctly configured, fix the sessionToken data leak in the dashboard Prisma query (SC-4), and verify the full system works end-to-end on the live URL.

Purpose: Phase 7's first deliverable is a live, correctly-configured production deployment. Without this, the simulation walkthrough cannot be tested on the real URL and no verification of the full system is possible.
Output: Live Vercel app at a public URL with all env vars set, secure Prisma query, and a human-verified production smoke test.
</objective>

<execution_context>
@/Users/davidkwartler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidkwartler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/07-deploy-and-polish/07-RESEARCH.md

<interfaces>
<!-- Key types and patterns the executor needs. -->

From src/app/(shop)/dashboard/page.tsx (current — UNSAFE query to be fixed):
```typescript
const sessions = await prisma.session.findMany({
  where: { expires: { gt: new Date() } },
  include: {
    fingerprints: { where: { isOriginal: true }, take: 1 },
    detectionEvents: { orderBy: { createdAt: "desc" }, take: 1 },
  },
  orderBy: { expires: "desc" },
})
```
This returns the full Session row including `sessionToken`. Fix: replace `include` with `select`
so `sessionToken` is never fetched. The SessionTable component expects:
```typescript
type SessionRow = {
  id: string
  detectionEvents: DetectionEventRow[]
  fingerprints: FingerprintRow[]
}
```
So `select` only needs: `id`, `expires`, `fingerprints` (nested select), `detectionEvents` (nested select).

From prisma/schema.prisma (Session model fields available):
- id, sessionToken, userId, expires

From prisma/schema.prisma (Fingerprint fields needed by SessionTable):
- visitorId, ip, userAgent

From prisma/schema.prisma (DetectionEvent fields needed by SessionTable):
- id, status, confidenceScore, reasoning

Auth.js v5 environment variables (v5 names — NOT v4):
- AUTH_SECRET (was NEXTAUTH_SECRET in v4)
- AUTH_GOOGLE_ID (was GOOGLE_CLIENT_ID in v4)
- AUTH_GOOGLE_SECRET (was GOOGLE_CLIENT_SECRET in v4)
- Do NOT set NEXTAUTH_URL on Vercel — auto-inferred from VERCEL env var

All required env vars:
- DATABASE_URL (pooled Neon connection string)
- AUTH_SECRET
- AUTH_GOOGLE_ID
- AUTH_GOOGLE_SECRET
- NEXT_PUBLIC_FINGERPRINT_API_KEY
- ANTHROPIC_API_KEY
- ANTHROPIC_MODEL (optional, defaults to claude-sonnet-4-6)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix dashboard Prisma query to exclude sessionToken (SC-4)</name>
  <files>src/app/(shop)/dashboard/page.tsx</files>
  <action>
    Replace the `prisma.session.findMany({ include: {...} })` call with an explicit `select` that
    only fetches the fields SessionTable actually renders — never fetching `sessionToken` or `userId`.

    Replace the current query:
    ```typescript
    const sessions = await prisma.session.findMany({
      where: { expires: { gt: new Date() } },
      include: {
        fingerprints: { where: { isOriginal: true }, take: 1 },
        detectionEvents: { orderBy: { createdAt: "desc" }, take: 1 },
      },
      orderBy: { expires: "desc" },
    })
    ```

    With a select-based query:
    ```typescript
    const sessions = await prisma.session.findMany({
      where: { expires: { gt: new Date() } },
      select: {
        id: true,
        expires: true,
        fingerprints: {
          where: { isOriginal: true },
          take: 1,
          select: {
            visitorId: true,
            ip: true,
            userAgent: true,
          },
        },
        detectionEvents: {
          orderBy: { createdAt: "desc" },
          take: 1,
          select: {
            id: true,
            status: true,
            confidenceScore: true,
            reasoning: true,
          },
        },
      },
      orderBy: { expires: "desc" },
    })
    ```

    This satisfies SC-4: "The deployed app does not expose raw session cookie values through any API
    endpoint." The sessionToken is never loaded into server memory and cannot leak through any
    future refactor that accidentally serializes the session object.

    Verify the TypeScript type inference still matches SessionTable's expected `SessionRow` type —
    the select shape must include: id (string), fingerprints (array with visitorId/ip/userAgent),
    detectionEvents (array with id/status/confidenceScore/reasoning). No type assertions needed;
    Prisma will infer the exact selected shape.
  </action>
  <verify>
    <automated>cd /Users/davidkwartler/sentinel && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    TypeScript compiles with no errors. The query uses `select` (not `include`). The word
    `sessionToken` does not appear in the select clause. The dashboard page still renders correctly
    (SessionTable receives id, fingerprints, detectionEvents).
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit and confirm all Vercel environment variables</name>
  <files></files>
  <action>
    Use the Vercel CLI to audit the current state of environment variables in the Vercel project.

    Step 1 — List current Vercel env vars (Production environment):
    ```bash
    cd /Users/davidkwartler/sentinel && vercel env ls production
    ```

    Step 2 — Cross-check against the required list. Every variable below MUST be present in
    Vercel's Production environment. For any missing variable, add it:
    ```bash
    vercel env add VARIABLE_NAME production
    ```

    Required variables and their sources:
    - DATABASE_URL — pooled Neon connection string from https://console.neon.tech (Connection Details → pooled)
    - AUTH_SECRET — generated with `npm exec auth secret` (v5 name; was NEXTAUTH_SECRET in v4)
    - AUTH_GOOGLE_ID — Google Cloud Console → APIs & Services → Credentials → OAuth 2.0 Client ID
    - AUTH_GOOGLE_SECRET — same OAuth 2.0 Client in Google Cloud Console
    - NEXT_PUBLIC_FINGERPRINT_API_KEY — FingerprintJS dashboard Public API Key
    - ANTHROPIC_API_KEY — https://console.anthropic.com → API Keys
    - ANTHROPIC_MODEL (optional) — set to "claude-sonnet-4-6" if desired

    Critical: Do NOT add NEXTAUTH_URL to Vercel — Auth.js v5 auto-infers from the VERCEL system
    env var. Setting it explicitly causes ERR_INVALID_URL on preview deployments.

    Step 3 — Deploy to production after env var changes:
    ```bash
    cd /Users/davidkwartler/sentinel && vercel --prod
    ```

    Step 4 — Capture the production URL from the Vercel CLI output (e.g., https://sentinel-xxx.vercel.app).
    Save this URL — it is needed for Plan 04 README rewrite.

    Step 5 — Add production OAuth callback URI to Google Cloud Console.
    Claude cannot do this via CLI (Google Cloud Console has no public CLI for OAuth client config).
    Record the required URI: https://[VERCEL_URL]/api/auth/callback/google
    This will be handled in the human verification checkpoint below.
  </action>
  <verify>
    <automated>cd /Users/davidkwartler/sentinel && vercel env ls production 2>&1</automated>
  </verify>
  <done>
    Vercel CLI shows all 6 required env vars present in Production environment. `vercel --prod`
    completes without error. A production URL is printed by the CLI.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    1. Fixed dashboard Prisma query to use `select` (excluding sessionToken) — SC-4 satisfied
    2. Audited and confirmed all Vercel environment variables set for Production
    3. Deployed to Vercel production (`vercel --prod`)
  </what-built>
  <how-to-verify>
    Before starting verification, add the production callback URI to Google Cloud Console:
    1. Go to https://console.cloud.google.com
    2. Navigate to APIs & Services → Credentials → your OAuth 2.0 Client
    3. Under "Authorized redirect URIs" click "Add URI"
    4. Add: https://[YOUR_VERCEL_URL]/api/auth/callback/google
    5. Click Save

    Then verify the production deployment:
    1. Visit the Vercel production URL (from Claude's output above)
    2. Verify the login page loads (no 500 error, no missing-env error)
    3. Click "Sign in with Google" — complete the OAuth flow
    4. Verify you land on /products and see the product listing
    5. Navigate to /dashboard — verify the session table renders
    6. Open browser DevTools → Network tab → filter for "/api/session/record"
    7. Verify a POST request succeeds (status 200) — fingerprint is being captured

    Optional (requires FingerprintJS Pro account active):
    - If the account is active, the visitorId column in the dashboard will show real fingerprint IDs
    - If inactive, the OSS fallback mode is used — rows will appear but with OSS-generated IDs

    To verify SC-4 (no cookie value exposure):
    8. Open DevTools → Network tab → click on any request to /api/session/record
    9. Check the Response JSON — it should contain {status, id, detected, eventId} — NOT sessionToken
    10. Check /dashboard — page source should not contain the auth_session cookie value
  </how-to-verify>
  <resume-signal>Type "approved" if production smoke test passes, or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors after the Prisma query fix
- `vercel env ls production` shows all 6 required env vars
- Production URL is accessible and Google OAuth completes successfully
- /dashboard renders the session table
- No raw sessionToken value appears in any API response or page source
</verification>

<success_criteria>
1. Vercel production URL is live and the full auth→products→dashboard flow works
2. All required env vars confirmed in Vercel Production environment
3. `src/app/(shop)/dashboard/page.tsx` uses `select` (not `include`) — sessionToken never fetched
4. TypeScript compiles without errors after the query change
5. Google Cloud Console has the production callback URI
</success_criteria>

<output>
After completion, create `.planning/phases/07-deploy-and-polish/07-01-SUMMARY.md` with:
- The Vercel production URL
- List of confirmed environment variables (names only, no values)
- Status of the Prisma query fix (before/after diff summary)
- Outcome of the production smoke test checkpoint
</output>
