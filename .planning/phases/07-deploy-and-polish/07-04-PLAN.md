---
phase: 07-deploy-and-polish
plan: 04
type: execute
wave: 2
depends_on:
  - 07-01
files_modified:
  - README.md
  - .env.local.example
autonomous: false
requirements:
  - DEPLOY-VALIDATION
# Note: Phase 7 introduces no new v1 requirement IDs. All 20 v1 requirements
# were satisfied in Phases 1-6. This plan produces the README and simulation
# walkthrough, satisfying Phase 7 Success Criteria SC-3 and SC-5.
# autonomous: false because the human verification checkpoint requires reviewing
# the live URL and confirming the simulation walkthrough is accurate.

must_haves:
  truths:
    - "README.md at repo root describes Sentinel (not the Next.js boilerplate stub)"
    - "README.md contains the live Vercel production URL"
    - "README.md contains an architecture overview explaining the hijack detection pipeline"
    - "README.md contains step-by-step local setup: clone → env vars → DB push → npm run dev"
    - "README.md contains the hijack simulation walkthrough (exact browser steps)"
    - ".env.local.example exists with all required variables, placeholder values, and source comments"
    - "The simulation walkthrough references auth_session cookie by name (not a generic 'session cookie')"
  artifacts:
    - path: "README.md"
      provides: "Complete project README with live URL, architecture, setup, simulation walkthrough"
      contains: "Hijack Simulation"
    - path: ".env.local.example"
      provides: "Copy-paste ready environment variable template"
      contains: "AUTH_SECRET"
  key_links:
    - from: "README.md"
      to: ".env.local.example"
      via: "reference in setup section"
      pattern: "\\.env\\.local\\.example"
    - from: "README.md"
      to: "https://[vercel-url].vercel.app"
      via: "live demo link"
      pattern: "vercel\\.app"
---

<objective>
Replace the boilerplate README with a complete project README for Sentinel and create a `.env.local.example` template that covers every required environment variable.

Purpose: Phase 7 SC-3 requires "a simulation walkthrough describing the exact steps to reproduce a hijack detection." SC-5 requires "README.md at the repo root with: project description with live Vercel URL, architecture overview, prerequisites, step-by-step local setup, a populated .env.local template, and the hijack simulation walkthrough."
Output: README.md (complete rewrite) and .env.local.example (new file).
</objective>

<execution_context>
@/Users/davidkwartler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidkwartler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/07-deploy-and-polish/07-01-SUMMARY.md
@.planning/phases/07-deploy-and-polish/07-RESEARCH.md

<interfaces>
<!-- Key facts the executor needs for the README content. -->

Project name: Sentinel
Core value: When a stolen session cookie is used from a different device, Sentinel detects it,
calls Claude for analysis, and flags the session with a confidence score on the dashboard.

Tech stack:
- Next.js 16 (App Router) + TypeScript
- Auth.js v5 with Google OAuth, database sessions (Session stored in Neon PostgreSQL)
- FingerprintJS Pro (client-side visitorId capture, cached in sessionStorage)
- Prisma 7 with @prisma/adapter-pg (Neon PostgreSQL via pg pool)
- Anthropic Claude API (structured outputs, async via next/server `after()`)
- Vercel (deployment, @vercel/analytics, @vercel/speed-insights)
- Tailwind CSS v4

Detection pipeline (for architecture section):
1. User signs in → Google OAuth → Auth.js creates database session → auth_session cookie set (HttpOnly, SameSite=Lax)
2. Any authenticated page load → FingerprintJS Pro captures visitorId → POSTs to /api/session/record
3. /api/session/record stores {sessionId, visitorId, os, browser, screenRes, timezone, ip, userAgent}
4. First fingerprint for a session is marked isOriginal=true
5. Subsequent fingerprints: runDetection() compares new visitorId against original
6. Mismatch → computeSimilarity() scores component-level similarity → DetectionEvent persisted (status=PENDING)
7. after() dispatches async Claude call → analyzeDetectionEvent() → structured {confidenceScore, reasoning}
8. confidenceScore >= 70 → status=FLAGGED; < 70 → status=CLEAR
9. /dashboard polls every 8s → SessionTable shows status badge → FLAGGED rows expandable (reasoning)

Cookie configuration (important for simulation walkthrough):
- Name: auth_session
- HttpOnly: true (cannot be read by JS)
- SameSite: lax (can be copied via DevTools Application panel)
- Secure: true in production (requires HTTPS — Vercel production URL)
- NOT accessible via document.cookie (HttpOnly)
- CAN be copied from DevTools → Application → Cookies → auth_session → Value field

FingerprintJS Pro account status: may be inactive (cancelled due to 90-day inactivity per STATE.md).
The FingerprintReporter supports OSS fallback mode via localStorage: fpMode = 'oss'.
The simulation walkthrough should mention both paths.

Auth.js v5 env var names (v5 — NOT v4):
- AUTH_SECRET (NOT NEXTAUTH_SECRET)
- AUTH_GOOGLE_ID (NOT GOOGLE_CLIENT_ID)
- AUTH_GOOGLE_SECRET (NOT GOOGLE_CLIENT_SECRET)
- Do NOT set NEXTAUTH_URL in Vercel env vars for v5

Google Cloud Console OAuth redirect URI requirement:
- Local: http://localhost:3000/api/auth/callback/google
- Production: https://[VERCEL_URL]/api/auth/callback/google

FLAGGED threshold: confidenceScore >= 70 (hardcoded in src/lib/claude.ts)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write README.md and .env.local.example</name>
  <files>
    README.md
    .env.local.example
  </files>
  <action>
    Read the 07-01-SUMMARY.md to get the actual Vercel production URL before writing.
    Replace the URL placeholder `[VERCEL_URL]` in README.md with the real URL.

    **README.md** — Complete replacement of the boilerplate. Structure:

    ```markdown
    # Sentinel

    > Session hijack detection powered by FingerprintJS Pro and Claude AI.

    **Live demo:** https://[VERCEL_URL]

    Sentinel is a Next.js application that detects when a stolen session cookie is used from a
    different device. When a fingerprint mismatch is detected, Claude analyzes the evidence and
    assigns a confidence score. Flagged sessions appear on the security dashboard with Claude's
    full reasoning.

    ## Architecture

    ```
    Browser (Device A)
        │ Google OAuth → auth_session cookie (HttpOnly, SameSite=Lax)
        │ Page load → FingerprintJS Pro → visitorId
        └─► POST /api/session/record
                │ Store Fingerprint (isOriginal=true for first fingerprint)
                │ runDetection(): compare new visitorId vs original
                │   ↳ Mismatch → computeSimilarity() → DetectionEvent (PENDING)
                │               → after() → analyzeDetectionEvent() [async]
                │                           └─► Claude API → {confidenceScore, reasoning}
                │                               confidenceScore ≥ 70 → FLAGGED
                │                               confidenceScore < 70 → CLEAR
                └─► /dashboard (polls 8s) → SessionTable → FLAGGED badge → expandable reasoning
    ```

    **Tech stack:** Next.js 16 · Auth.js v5 · FingerprintJS Pro · Prisma 7 · Neon PostgreSQL ·
    Anthropic Claude · Vercel

    ## Prerequisites

    - Node.js 20+
    - A [Neon](https://neon.tech) PostgreSQL database (free tier works)
    - A [Google Cloud Console](https://console.cloud.google.com) project with an OAuth 2.0 client
    - A [FingerprintJS Pro](https://fingerprint.com) account (free trial available)
    - An [Anthropic](https://console.anthropic.com) API key

    ## Local Setup

    ### 1. Clone and install

    ```bash
    git clone https://github.com/[your-username]/sentinel.git
    cd sentinel
    npm install
    ```

    ### 2. Configure environment variables

    Copy the template and fill in your values:

    ```bash
    cp .env.local.example .env.local
    ```

    Edit `.env.local` — every variable is documented in the file with links to where to get each
    credential. See [`.env.local.example`](.env.local.example) for details.

    ### 3. Set up the database

    Push the Prisma schema to your Neon database:

    ```bash
    npx prisma db push
    ```

    ### 4. Start the development server

    ```bash
    npm run dev
    ```

    Open [http://localhost:3000](http://localhost:3000). Sign in with Google to verify the setup.

    ### 5. Google Cloud Console: add authorized redirect URIs

    In Google Cloud Console → APIs & Services → Credentials → your OAuth 2.0 Client:
    - Add `http://localhost:3000/api/auth/callback/google` for local development
    - Add `https://[VERCEL_URL]/api/auth/callback/google` for production

    ## Hijack Simulation Walkthrough

    This walkthrough reproduces a session cookie theft and detection end-to-end.

    **Prerequisites:** Two different browsers (e.g., Chrome and Firefox) and the app running.

    ### Step 1: Establish a session on Device A

    1. Open **Browser A** (e.g., Chrome)
    2. Navigate to the app and sign in with Google
    3. You will land on `/products`
    4. Open DevTools → **Application** → **Cookies** → find `auth_session`
    5. Copy the full cookie **Value** (a long alphanumeric string)

    ### Step 2: Simulate the attacker on Device B

    1. Open **Browser B** (e.g., Firefox — must differ from Browser A to get a different fingerprint)
    2. Navigate to the same app URL
    3. Open DevTools → **Storage** → **Cookies** (Firefox) or **Application** → **Cookies** (Chrome)
    4. Create a new cookie:
       - Name: `auth_session`
       - Value: *(paste the value copied from Step 1)*
       - Domain: `localhost` (or your Vercel domain, without `https://`)
       - Path: `/`
    5. Navigate to `/products` in Browser B — **without signing in**

    ### Step 3: Observe detection

    1. Browser B loads the products page using Browser A's session
    2. FingerprintJS records Browser B's visitorId — different from Browser A's
    3. The detection engine flags the mismatch and dispatches Claude asynchronously
    4. Wait **10–15 seconds** for Claude to complete analysis
    5. In **Browser A**, navigate to `/dashboard`
    6. The dashboard shows the session with a red **FLAGGED** badge
    7. Click the flagged row to expand Claude's reasoning transcript

    > **FingerprintJS Pro note:** If the Pro account is inactive, the app falls back to OSS mode.
    > To force OSS mode manually: open DevTools → Console → run `localStorage.setItem('fpMode', 'oss')` → reload.
    > In OSS mode, fingerprints are less stable but the detection pipeline still functions for demo purposes.

    ## Running Tests

    ```bash
    npm run test:run
    ```

    Tests cover: `computeSimilarity` edge cases, `runDetection` transaction logic (mocked DB),
    and `POST /api/session/record` response shapes (401 auth guard, 400 validation, 200 duplicate).

    ## Deploying to Vercel

    1. Push to GitHub
    2. Import the repo in [Vercel Dashboard](https://vercel.com/new)
    3. Add all environment variables (see `.env.local.example` for the full list)
    4. **Do not** set `NEXTAUTH_URL` — Auth.js v5 infers it automatically on Vercel
    5. Deploy — Vercel runs `npm install` which auto-generates the Prisma client via postinstall
    6. After deploy, add the Vercel production URL to Google Cloud Console → Authorized redirect URIs

    ## Project Structure

    ```
    src/
    ├── app/
    │   ├── (shop)/           # Auth-gated route group
    │   │   ├── layout.tsx    # Shared nav + FingerprintReporter
    │   │   ├── products/     # Product listing
    │   │   ├── profile/      # User profile
    │   │   └── dashboard/    # Security dashboard (SessionTable, PollingRefresher)
    │   ├── api/
    │   │   └── session/record/  # POST: fingerprint ingest + detection + Claude dispatch
    │   └── login/            # Sign-in page
    ├── components/
    │   ├── SessionTable.tsx   # Dashboard table with expandable FLAGGED rows
    │   └── FingerprintReporter.tsx  # Client component: FingerprintJS capture + POST
    └── lib/
        ├── auth.ts           # Auth.js v5 config (Google provider, database sessions)
        ├── db.ts             # Prisma singleton
        ├── detection.ts      # computeSimilarity() + runDetection()
        └── claude.ts         # analyzeDetectionEvent() with structured outputs
    prisma/
    └── schema.prisma         # User, Session, Fingerprint, DetectionEvent models
    ```
    ```

    **`.env.local.example`** — new file at the repo root:

    ```bash
    # ============================================================
    # Sentinel — Local Development Environment Variables
    # Copy this file to .env.local and fill in your values.
    # NEVER commit .env.local to git (it is in .gitignore).
    # ============================================================

    # ---- Database (Neon PostgreSQL) ----------------------------
    # Get from: https://console.neon.tech
    # Create a project → Connection Details → copy the "Pooled connection" string.
    # Always use the POOLED URL for serverless (not the direct/unpooled variant).
    DATABASE_URL="postgresql://user:password@ep-xxx.us-east-1.aws.neon.tech/dbname?sslmode=require"

    # ---- Authentication (Auth.js v5 / Google OAuth) ------------
    # AUTH_SECRET: Generate with: npm exec auth secret
    # Copy the output string. This encrypts session cookies.
    AUTH_SECRET="your-generated-secret-here"

    # AUTH_GOOGLE_ID + AUTH_GOOGLE_SECRET:
    # Get from: https://console.cloud.google.com
    # APIs & Services → Credentials → Create OAuth 2.0 Client ID (Web application)
    # Authorized redirect URI for local: http://localhost:3000/api/auth/callback/google
    AUTH_GOOGLE_ID="your-client-id.apps.googleusercontent.com"
    AUTH_GOOGLE_SECRET="your-client-secret"

    # IMPORTANT: Do NOT set NEXTAUTH_URL on Vercel.
    # Auth.js v5 auto-infers the URL from Vercel's system environment variables.
    # Only set this for local development:
    NEXTAUTH_URL="http://localhost:3000"

    # ---- FingerprintJS Pro -------------------------------------
    # Get from: https://dashboard.fingerprint.com
    # Create an application → copy the Public API Key.
    # The NEXT_PUBLIC_ prefix is required — this key loads in the browser.
    NEXT_PUBLIC_FINGERPRINT_API_KEY="your-fingerprintjs-public-api-key"

    # ---- Anthropic (Claude AI) ---------------------------------
    # Get from: https://console.anthropic.com → API Keys
    ANTHROPIC_API_KEY="sk-ant-..."

    # Model to use for detection analysis (optional).
    # Defaults to claude-sonnet-4-6 if not set.
    ANTHROPIC_MODEL="claude-sonnet-4-6"
    ```

    Important notes on writing these files:
    - In README.md, replace `[VERCEL_URL]` with the actual production URL from 07-01-SUMMARY.md
    - In README.md, replace `[your-username]` with the actual GitHub username (check git remote)
    - The `.env.local.example` file must use placeholder values — never real credentials
    - Verify `.env.local.example` is NOT in `.gitignore` (it should be committed — it's a template)
    - Verify `.env.local` IS in `.gitignore` (it should not be committed — it has real secrets)

    To get the GitHub username:
    ```bash
    cd /Users/davidkwartler/sentinel && git remote get-url origin
    ```
  </action>
  <verify>
    <automated>cd /Users/davidkwartler/sentinel && ls -la README.md .env.local.example && grep -l "Sentinel" README.md && grep -l "AUTH_SECRET" .env.local.example</automated>
  </verify>
  <done>
    README.md exists at repo root and contains "Sentinel" and "Hijack Simulation" and the live
    Vercel URL. .env.local.example exists with AUTH_SECRET, AUTH_GOOGLE_ID, AUTH_GOOGLE_SECRET,
    DATABASE_URL, NEXT_PUBLIC_FINGERPRINT_API_KEY, ANTHROPIC_API_KEY as placeholder values.
    Neither file contains real credentials (all values are placeholder strings like "sk-ant-...").
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    1. README.md — complete replacement of the boilerplate with Sentinel documentation:
       project description, live Vercel URL, architecture diagram, prerequisites, local setup
       (clone → env vars → db push → npm run dev), hijack simulation walkthrough, test instructions
    2. .env.local.example — copy-paste ready template with all required variables and source comments
  </what-built>
  <how-to-verify>
    Review README.md at the repo root:
    1. Confirm the project description is accurate and makes sense to a first-time viewer
    2. Confirm the live Vercel URL is correct (matches the deployed app from Plan 01)
    3. Walk through the local setup steps — verify they match the actual project (npm install,
       cp .env.local.example .env.local, npx prisma db push, npm run dev)
    4. Read the Hijack Simulation Walkthrough — confirm the steps are accurate:
       - Browser A: sign in, DevTools → Application → Cookies → auth_session → copy Value ✓
       - Browser B: create cookie with same name, paste value, navigate to /products ✓
       - Dashboard: wait 10-15s, see FLAGGED badge, click to expand reasoning ✓
    5. Review .env.local.example:
       - All 6 required variables present (DATABASE_URL, AUTH_SECRET, AUTH_GOOGLE_ID,
         AUTH_GOOGLE_SECRET, NEXT_PUBLIC_FINGERPRINT_API_KEY, ANTHROPIC_API_KEY) ✓
       - All values are placeholders, no real credentials ✓
       - Comments explain where to get each credential ✓

    Perform the simulation (optional but recommended):
    - Follow the walkthrough using the live Vercel URL
    - Confirm a FLAGGED session appears in the dashboard after ~15 seconds
  </how-to-verify>
  <resume-signal>Type "approved" if README and simulation walkthrough are accurate, or describe corrections needed</resume-signal>
</task>

</tasks>

<verification>
- README.md exists and is no longer the Next.js boilerplate
- README.md contains: Sentinel description, Vercel URL, architecture section, prerequisites,
  local setup steps (clone/install/env/db push/dev), simulation walkthrough, test instructions
- .env.local.example exists with all required variables and placeholder values
- `git status` shows README.md and .env.local.example as modified/new
- .env.local.example is staged for commit (it is a template, meant to be committed)
- .env.local is NOT staged (it contains real credentials, is gitignored)
</verification>

<success_criteria>
1. README.md contains the live Vercel production URL
2. README.md contains the exact 3-step hijack simulation walkthrough (Device A → cookie copy → Device B → dashboard)
3. .env.local.example has all 6 required variables with placeholder values and source comments
4. Human verification checkpoint approved
</success_criteria>

<output>
After completion, create `.planning/phases/07-deploy-and-polish/07-04-SUMMARY.md` with:
- Confirmation that README.md and .env.local.example were written
- Verification checkpoint outcome (approved / issues found + fixes applied)
- The final Vercel production URL as recorded in the README
</output>
